---
title: "EDA of Spanish electricity generation time series"
output:
  html_document:
    df_print: paged
---

#### Next steps

-   Investigate seasonality and long-term trends for each variable

-   

```{r libraries, message=FALSE, warning=FALSE, error=FALSE}
# Load libraries
library(RCurl)
library(tidyverse)
library(magrittr)R
library(plotly)
library(imputeTS)
library(lubridate)
library(timetk)
```

```{r echo=TRUE}
# Load data (relative file path) and view contents
df <- read.csv("../data/energy_dataset.csv")
head(df)
```

```{r}
dim(df) # Number of rows and columns
```

```{r}
summary(df) # Distribution and missingness for each variable
#describe(df)
```

## Missing data

There are eight columns that contain no values (all NAs or zeroes). These are removed here.

```{r}
df_clean <- df %>% 
  select(-c(generation.fossil.coal.derived.gas,
            generation.fossil.oil.shale,
            generation.fossil.peat,
            generation.geothermal,
            generation.marine,
            generation.hydro.pumped.storage.aggregated,
            generation.wind.offshore,
            forecast.wind.offshore.eday.ahead))
```

```{r}
colSums(is.na(df_clean)) # Number of missing values for each remaining variable
```

16 out of 22 of the remaining variables each have a maximum of 36 missing values. Looking at where these occur, we see that most missing values occur across variables. Specifically, 90% of the missing values occur over only 18 rows. The remaining 10% are spread across 28 rows.

```{r}
# Rows where data is missing
df_clean[!complete.cases(df_clean),]
```

```{r}
# Number of NAs per row
missing_per_row <- rowSums(is.na(df_clean[!complete.cases(df_clean),]))
missing_per_row
sum(missing_per_row > 1)
sum(missing_per_row[missing_per_row > 1])/sum(missing_per_row)
```

What are we left with?

```{r}
tail(df_clean)
```

35,000 obs across 20 variables, hourly from start 2015 to end 2018:

-   Energy generation from 14 different sources

-   Forecast onshore wind and solar, one day ahead

-   Forecast and actual total electricity load

-   Forecast and actual electricity price

And in the other dataset, not yet loaded: hourly weather data over the same period for a number of Spanish cities

## Plotting

```{r}
# Formatting time variable to datetime object
# NB:  Time contains both UTC+1 and UTC+2 time-zones - date functions automatically pick this up and convert to UTC

df_clean$time <- as_datetime(df_clean$time)
head(df_clean)
```

### Focusing on generation variables

```{r}
gen_data <- df_clean %>% 
  select(c(1, starts_with("generation")))
```

```{r}
# Converting to long form
long_gen_data <- gen_data  %>% 
  pivot_longer(cols = -time, names_to = "generation_source") %>% 
  mutate(generation_source = str_replace(generation_source, "generation.", ""))

head(long_gen_data)
```

Plot distribution of (generation) data missingness

```{r}
# NB: MAYBE DON'T DO WHOLE DATASET LOCALLY, IT CRASHED MY R SESSION
long_gen_data_small <- long_gen_data[1:10000,]
ggplot_na_distribution(x=long_gen_data_small$value, y=long_gen_data_small$time)
```

Smoothing the data on a daily scale

```{r}
gen_data_smoothed <- long_gen_data %>% 
  group_by(generation_source) %>% 
  summarise_by_time(time, .by = 'day', adjusted = mean(value)) 

head(gen_data_smoothed)
```

Looking at four series over time in isolation, with quarterly smoothing (This function is nice as it includes an interactive feature)

```{r}
gen_data_smoothed %>% filter(generation_source %in% c(
  "biomass", "fossil.gas", "nuclear", "solar")) %>% 
  plot_time_series(time, adjusted, .facet_ncol = 2,
                   .smooth_period = "3 months")
```

#### Looking at all generation sources together on an area chart

##### Long-term trends

```{r}
long_gen_data %>% 
  group_by(generation_source) %>% 
  summarise_by_time(time, .by = '2 months', adjusted = mean(value)) %>% 
  ggplot() +
  geom_area(aes(x = time, y = adjusted, fill = generation_source), stat = "identity") + 
  #geom_line(data = df_clean, aes(x = time, y = total.load.actual)) +
  theme_minimal()
```


```{r}
long_gen_data$year <- year(long_gen_data$time)
long_gen_data$month <- month(long_gen_data$time)
long_gen_data$day <- day(long_gen_data$time)
long_gen_data$hour <- hour(long_gen_data$time)
```


##### Seasonality within a day 

```{r}

hourly_generation_plot_by_year <- long_gen_data %>%
  ggplot(aes(x = hour, y = value, fill = generation_source)) +
  geom_bar(stat = "identity")

hourly_generation_plot_by_year
```

##### Seasonality within a month 

```{r}
daily_generation_plot_by_year <- long_gen_data %>%
  ggplot(aes(x = day, y = value, fill = generation_source)) +
  geom_bar(stat = "identity") +
  facet_wrap(~year) + theme(legend.position = "none") 

daily_generation_plot_by_year
```

##### Seasonality within a year 

```{r}
monthly_generation_plot <- long_gen_data %>%
  ggplot(aes(x = month, y = value, fill = generation_source)) +
  geom_bar(stat = "identity") +
  facet_wrap(~year)

monthly_generation_plot
```

```{r, include=FALSE}
price_vs_forecast <- df_clean %>%
  select(., c(time, price.actual, price.day.ahead)) 

## Need to offset by a day before taking difference?
price_vs_forecast$difference <- price_vs_forecast$price.day.ahead - price_vs_forecast$price.actual

price_vs_forecast %>%
  ggplot() +
  geom_line(aes(x=time, y=difference)) +
  ylab("Difference between predicted and actual price")
```

```{r, include=FALSE}
load_vs_forecast <- df_clean %>%
  select(., c(time, total.load.actual, total.load.forecast))

load_vs_forecast$difference <- load_vs_forecast$total.load.forecast - load_vs_forecast$total.load.actual

load_vs_forecast %>%
  ggplot() +
  geom_line(aes(x=time, y=difference)) +
  ylab("Difference between predicted and actual load")

```
### To discuss
```{r, include=TRUE}




datain <- long_gen_data %>% group_by(generation_source, year, day, month) %>% summarise(across(c(value), c(max, min)))

datain <- datain %>%
  mutate(date = make_date(year, month, day))
head(datain)
names <- unique(datain$generation_source)
for(name in names){
  datain2 <- filter(datain, generation_source == name)
  print(datain2 %>% ggplot()+geom_line(aes(x = date, y = (value_1 - value_2)/((value_1+value_2)/2) , color = generation_source))+theme(legend.position="bottom") + ggtitle(name)
)
}


```

```{r, include=TRUE}




datain <- long_gen_data %>% group_by(generation_source, year, day, month) %>% summarise(across(c(value), c(max, min)))

datain <- datain %>%
  mutate(date = make_date(year, month, day))
head(datain)
names <- unique(datain$generation_source)
for(name in names){
  datain2 <- filter(datain, generation_source == name)
  print(datain2 %>% ggplot()+geom_line(aes(x = date, y = value_1, color = "max"))+geom_line(aes(x = date, y = value_2, color = "min"))+theme(legend.position="bottom")+ggtitle(name)
)
}


```
```{r, include=TRUE}


long_gen_data[is.na(long_gen_data)] <- mean(long_gen_data$value)


datain <- long_gen_data %>% group_by(generation_source, year, month) %>% summarise(across(c(value), c(max, min)))
datain2 <- datain %>%
  mutate(date = make_date(year, month))

head(datain2)
names <- unique(datain2$generation_source)
for(name in names){
  datain3 <- filter(datain2, generation_source == name)
  print(datain3 %>% ggplot()+geom_line(aes(x = date, y = value_1, color = "max"))+geom_line(aes(x = date, y = value_2, color = "min"))+theme(legend.position="bottom")+ggtitle(name))
}

```

\`\`\`
