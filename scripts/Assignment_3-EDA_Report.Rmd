---
title: "EDA of Spanish electricity generation 2015-2018"
subtitle: 'Group 17: Time Series - Assignment 3 - EDA Report'
output:
  pdf_document:
    toc: no
    toc_depth: '2'
  html_document:
    toc: yes
    toc_depth: 2
    fig_caption: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.align = 'center')
```

```{r libraries, echo=FALSE, message=FALSE, warning=FALSE}
# Load libraries
library(tidyverse)
library(magrittr)
library(lubridate)
library(imputeTS)
library(modelsummary)
library(corrplot)
library(plotly)
library(timetk)
#library(GGally)
```

```{r data, echo=FALSE, message=FALSE, warning=FALSE}
df <- read.csv("../data/energy_dataset.csv")

# Change to datetime var
df$time <- as_datetime(df$time, tz="CET")

# Removing variables with no values
unimputed_data <- df %>%
  select(-c(generation.fossil.coal.derived.gas,
                    generation.fossil.oil.shale,
                    generation.fossil.peat,
                    generation.geothermal,
                    generation.marine,
                    generation.hydro.pumped.storage.aggregated,
                    generation.wind.offshore,
                    forecast.wind.offshore.eday.ahead)) 

# Removing outliers
outlier_rows <- unimputed_data[unimputed_data$time %in% ymd_hms('2017-11-12 20:00:00', '2017-11-14 11:00:00', '2017-11-14 18:00:00'),]

outlier_rows[outlier_rows == 0] <- NA

unimputed_data_cleaner <- unimputed_data

unimputed_data_cleaner[unimputed_data_cleaner$time %in% ymd_hms('2017-11-12 20:00:00', '2017-11-14 11:00:00', '2017-11-14 18:00:00'),] <- outlier_rows

# Interpolating missing values
data <- unimputed_data_cleaner %>% 
          mutate(across(generation.biomass:price.actual, .fns = na_interpolation, option = 'linear')) %>% 
          select(c(1, starts_with("generation")))

# Giving vars simpler names
names(data) <- c("time",
                 "Biomass",
                 "Lignite",
                 "Gas",
                 "Hard Coal",
                 "Oil",
                 "Hydro Pumped",
                 "Hydro River",
                 "Hydro Reservoir",
                 "Nuclear",
                 "Other",
                 "Other Renewable",
                 "Solar",
                 "Waste",
                 "Wind Onshore")
        

data_long <- data %>% pivot_longer(cols = -time, names_to = "generation_source")
```

Daniel Petterson (300467629), Rob Tomkies (300588353), and Daniel Wrench (300398222)

**Due 5pm Tuesday 31st August**

This report is accompanied by an [online dashboard](https://danielpetterson.shinyapps.io/scripts/), developed in R Shiny. The app allows interactive visualisation and comparison of each time series, and is discussed in greater detail in the section [Time series visualisation].

# Background and Data

*1-3 pages, 6 marks*

We chose to study a time series dataset about electricity generation in Spain over a four-year period. This data originally comes from the "ENTSO-E Transparency Platform" dashboard (<https://transparency.entsoe.eu/dashboard/show>). ENTSO stands for *European Network of Transmission System Operators for Electricity*, and this website is the central collection and visualisation repository of electricity generation, transportation and consumption data across Europe. European Member States are required to submit this data to this platform. The data for Spain from the start of 2015 to the end of 2018 was collected from the dashboard and published on the data repository website Kaggle. This is where the data for this report was downloaded from (<https://www.kaggle.com/nicholasjhana/energy-consumption-generation-prices-and-weather>). *Chuck the links in this paragraph in footnotes?*

The raw dataset from Kaggle contained variables for electricity consumption, generation, and pricing, recorded every hour of the four years, as well as day-ahead forecasts. For this exploration of the data, we limited our investigation to hourly electricity generation, which is divided into several different generation sources/methods.

In 2009 Spain became subject to EU Directive 2009/28/EC which mandates an EU-wide commitment to expanding the use of renewable energy (https://eur-lex.europa.eu/eli/dir/2009/28/oj). The target was for 20% of all energy consumed in the bloc to be generated by renewable sources by 2020.The Spanish government subsequently published the Plan de Energias Renovables 2011-2020 outlining how it planned to meet its commitments.(https://www.idae.es/sites/default/files/documentos/publicaciones_idae/documentos_11227_per_2011-2020_def_93c624ab.pdf)

The question we formulated to guide our EDA is as follows:

**How does the amount of electricity generated by different sources change over time, individually and with respect to other sources?**

This question is worth investigating due to the pressing global challenge of climate change, and the consequent need for countries to transition to a sustainable energy economy. In order for this to be possible, we need to understand how electricity is currently being generated and what the long-term trends are, to see whether a nation's energy policy should continue or diverge from the current trajectory. Furthermore, governments need to know how electricity generation sources vary seasonally and what interdependencies there are.


After removing the variables that were not relevant to our analysis, and those that contained no observations, the dataset contained hourly recordings of the amount of power generated from 14 different sources in Spain between 2015 and 2019. The definitions of each of these sources are reasonably self-explanatory, and we have expanded in further detail during our analysis when it is helpful.

As well as some missing values (discussed further below), we also discovered some outliers. Interestingly, these occurred across variables at the exact same timestamps. Specifically, we identified 3 rows in the raw dataset in which all but one generation source recorded a value of 0. This is shown in the plot below:

<center>
![](../figures/strange_zeros.png){width=80%}
</center>

Because they seem very unlikely to be true values, these outliers were removed. *We also identified two other rows where values were a significant departure from the typical range of that source, but were not equal to zero. These have not been removed because they could be plausible values.*

After removing the outliers, each variable had between 18 and 22 missing values. Most of these missing values occurred across variables: there were 21 rows for which data for all or all but one variables were missing, and five rows in where only one variable was missing. In most cases, we were confident in imputing the missing values using linear interpolation. However, there was one area of slight concern: of the 26 rows with missing data, six of them are consecutive. The plots below show how this imputation affected some of the variables.

```{r interpolation plot 1}
# Creating interpolation indicator vars
data$interp_gas <- as.integer(is.na(unimputed_data$generation.fossil.gas))
data$interp_solar <- as.integer(is.na(unimputed_data$generation.solar))

# Note that using geom_point is strictly more accurate
ggplot(data[50:150,]) + geom_point(aes(x= time, y = Solar, colour = interp_solar), show.legend = FALSE) + scale_color_gradient(low="black", high="red") + labs(x = '', title = "Solar variable post-linear interpolation")
```

The linear interpolation over the adjacent missing values in the Solar variable did not follow the strong seasonal pattern observed for this variable.

```{r interpolation plot 2}
ggplot(data[50:150,]) + geom_point(aes(x= time, y = `Gas`, colour = interp_solar), show.legend = FALSE) + scale_color_gradient(low="black", high="red") + labs(x = '', title = "Gas variable post-linear interpolation")

# Removing indicator vars
data <- data %>% select(-c(interp_gas, interp_solar))
```

The linear interpolation over the adjacent missing values in the Gas variable looks as if it may also result in (very minor) distortion of the fluctuation in this variable, but it is less obvious than for Solar.

Overall, despite linear interpolation not following the trend of the data for some variables, this gap represents a very small proportion of each time series, so we were content to make this small distortion of the data and apply the method.

# Ethics, Privacy, and Security

## Ethics

While there is no intention to utilize this study for any purpose beyond academic, the ethical concerns relating to this project entirely come from possible uses and interpretations of the outputs of this study in the real world. Primarily these would relate to political decisions of national energy policy and investment. Spain has an established nuclear sector which has had opposition since the 1950s when the government initially announced its intentions to develop the capability (<https://en.wikipedia.org/wiki/Anti-nuclear_movement_in_Spain> ). The arguments against nuclear largely focus on the hazardous waste, potential consequences of disaster and association with weapons of mass destruction. If this paper were utilized to argue for further development of Spain's nuclear power industry, considerations surrounding these concerns must be considered. Similarly, there are growing concerns surround hydrocarbon-based fuel sources and the impact on climate and air quality, this study specifically makes no recommendations however should people decide to develop hydrocarbon-based energy sources they would need to consider the ethics of the impacts on the environment. Interestingly the existence of global warming is a political and, in some ways, ethical issue and so this would also need to be considered if information from this study were used to support or disprove it.

Any decisions relating to a change in the energy sector would impact people in several ways beyond the ethical concerns relating to the technology. Any modelling completed from this data is at a national level and so assumes a uniform complete accessibility to energy from all sources, this is inherently not the case. If the government decided to shift to a non-diversified energy model or banned local diesel generators there is the small possibility that areas, most likely rural, would no longer have access to electricity and have an adverse effect on these people lives. More likely is where, due to political pressure, the government chooses to invest in a more expensive source of energy, for example due to a drive to achieve a higher proportion of green energy ( <https://www.theguardian.com/environment/2019/jun/14/power-to-the-people-how-spanish-cities-took-control-of-energy> ). Pushing power prices up would disproportionately affect people from a lower socioeconomic background and fuel a growing divide between the classes and creating a growing poverty in the country. This could be further exacerbated if with the investment in new technology automation is increased, leading to greater efficiency at the cost of lower skilled jobs, again disproportionately affecting the lower socioeconomic class.

There is a small risk of the creation of feedback cycles relating to the above concerns. This would only occur if decisions made based on the results of this study created a negative affect as discussed above, which was then integrated into another model which the further exacerbated the issue in turn. As this study is a non-reactive one off and there is no intention to base decision making upon the models of this exercise, the concern of feedback loops has been considered outside the remit of the ethical concerns of this study.

Spain has many formally recognized ethnicities and minorities (<https://minorityrights.org/country/spain/>) however the Spanish Personal Data Protection Act No. 15/1999 does not extend any explicit protection for or guidance on the use and storage of data from these groups. This means that handling approaches and considerations like the protective measures and regulations offered to people such as the Māori in New Zealand are not present or relevant in Spanish law (<https://ec.europa.eu/newsroom/just/redirection/document/45791>). Furthermore, this data is recorded and stored at a national level from generation source rather than a conglomerate of personal data and as such there is little about personal ethics and the use of personal data that is relevant or of concern to this study. There are no religious concerns with energy modelling beyond those discussed to do with the environment and social impacts.

## Privacy

Privacy relates to your right not to be asked invasive questions or to needlessly provide personal information as well as the assurance that any publications made from the data cannot be used to identify you. The data from this study was collected at source of generation and then generalized to a national resolution. This means that there has never been any personal information stored within the data and would only be a concern if the data was comprised of the sum of individuals energy use added up and then anonymised. A larger concern relates to if the data was of finer resolution, such as region or street where theoretically if the sample size is small, even with anonymised data, individuals could be identified with local knowledge, again this is not the case as information is provided at a national level and measures taken at source. This means that data anonymisation techniques such as differential privacy are not only not necessary, but detrimental to the accuracy.

Beyond personal privacy, as this data is available publicly from Spanish TSO Red Electric España there is no concern of corporate property breach. Further to this, the body holding the data is the national government body, they have ensured that it complies with both Spanish and European data privacy regulations.

## Security

Confidentiality, integrity, and availability are the three main factors that should be considered when ensure the security of the project. Confidentiality is ensured through the resolution of the data being at a national scale and being collected at source thus ensuring no identifiable information is available in the first place. This data is publicly available and so there is no need to ensure that this data is kept fully secure while handling it. If there were identifiable aspects to the original data, the responsibility to ensure this information is secure lies with the body holding the information and to ensure they are compliant with any national or European data laws. The analysis, organization and modelling were completed and stored through Microsoft Teams, a git repository and Overleaf which all require a minimum password protection or multifactor authentication. While the information within each storage means does not need to be protected, each company has a responsibility to protect the personal information of our team.

Integrity was maintained through the upkeep of a git repository ensuring that we had a complete record of any code and any changes made to the code throughout. This ensured the code present was the most up to date and relevant while also allowing us to keep records of versions throughout the project in case of needing to roll back edits to the code. The data was linked directly to the Kaggle dataset to ensure no local edits would affect it; this does mean that we relied on the integrity of the Kaggle dataset. Access to edit all files was only allowed through team members accounts which were all password protected. Even if someone obtained access to the files and made unregulated changes, these would also be recorded through git and recorded, ensuring that it would be simple to a point we were sure the code was correct and our work.

Availability of data and files was ensured through utilizing cloud-based platforms for all data, codes, and reports. This ensures that all members of the team could access all files in their most up to date format provided an internet connection was present. Each update to the formats would be associated with the respective team member account and so would be authorized within the platform. All platforms are mainstream and so utilize top level protection however should the servers go down due to something such as a DDOS attack, each git repository is stored locally on devices as well so one of us would have the most up to date file.

# Exploratory Data Analysis

*3-8 pages, 15 marks*

## Overall statistics

```{r summary stats, echo=FALSE}
# Changing the order of the variables from largest to smallest
data_table <- data %>% select(c("Nuclear", "Gas", "Wind Onshore", "Hard Coal", "Hydro Reservoir", "Solar", "Hydro River", "Lignite", "Hydro Pumped", "Biomass", "Oil", "Waste", "Other Renewable", "Other"))
# Creating CV statistic function
CV <- function(x) sd(x)/mean(x)
f <- All(data_table) ~ Mean + SD + CV + Min + Median + Max + Histogram
datasummary(f, data_table, output="markdown") # Previously output = "markdown"
```
The table above shows summary statistics for every generation source in the dataset, ordered from largest to smallest mean hourly value. This allows a quick comparison of the magnitude and variability of each source. We can see that Nuclear has the largest average hourly generation, but a relatively low standard deviation. This combination of high production and low variability, an important measure for understanding an electricity system, is best summarised by the coefficient of variation (CV) statistic. Nuclear has the lowest CV out of all sources. This statistic helps us understand the difference between intermittent sources (high CV, such as Solar and Wind Onshore), and continuous sources (low CV, such as Nuclear, Oil, and Gas).

As discussed in the Background section, understanding interdependencies between electricity generation sources is important to maintaining energy availability in the short- and medium-term, but also to manage energy transition in the long-term. We calculated correlations as a way of investigating relationships in the dataset.

```{r correlation plot, echo=FALSE, warning=FALSE}
# Correlation plot
df_corr <- data[,2:ncol(data)]

corrmatrix <- df_corr %>% cor()
corrplot(corrmatrix, method = "color", addCoef.col="black", order = "FPC", number.cex= 0.7, tl.cex=0.5, tl.col = "black", type = 'lower', cl.pos = 'n')
```

Nuclear, the largest overall contributor to electricity generation, does not have any significant correlations. Therefore, not only is Nuclear an incredibly steady generation source, it is also one that does not depend on or affect the amount of electricity produced by other sources. Solar, on the other hand, is a much more variable source, but this correlation plot shows it is also a very independent generation method.

The three least independent generation sources - those most related to other sources - are Hard Coal, Hydro River, and Other Renewable. The largest correlation in the dataset is a positive correlation of 0.77 between Hard Coal and Lignite. Lignite is another type of coal, so it makes sense that these two sources would change in tandem. Other correlations are investigated further in the discussion of the time series plots in the next section.

## Time series visualisation

The [R Shiny dashboard](https://danielpetterson.shinyapps.io/scripts/) accompanies this section of the EDA. The dashboard allows interactive exploration of each electricity generation source over time, with customisation of which time period to look at, how much to smooth the data, and how to compare the variables. Here, we focus on the most interesting patterns.

The plot below shows the five sources in the data with the most significant long-term trends over the four-year period. The similar or opposite nature of these trends between these generation sources are reflected in strong positive or negative correlations.

<center>

![**Biomass, Oil, Other Renewable, Other, and Waste time series with monthly smoothing**](../figures/5_sources.png){width=80%}

</center>

Hard Coal and Hydro River, as shown in the correlation plot, are the two least independent generation sources - in other words, those most related to the values of other sources. The plot below shows some examples of this interdependence, by plotting the mean-centered variation over time of Hard Coal, Hydro River, and Hydro Reservoir.

```{r mean centered}
center_scale <- function(x) {
  scale(x, scale=FALSE)
}

data_centered <- data %>%
  select(c("Hard Coal", "Hydro Reservoir", "Hydro River")) %>%
  mutate_all(., center_scale) %>%
  mutate(time = data$time) %>%
  pivot_longer(cols = -time, names_to = "generation_source") %>% 
  group_by(generation_source) %>% 
  summarise_by_time(time, .by = "monthly", adjusted = mean(value))

ggplot(data_centered)+
  geom_line(aes(x=time, y=adjusted, color=generation_source))+
  geom_hline(yintercept=0, linetype="dashed")+
  labs(x="Time", y="Difference from Mean (MW)", title="Mean Centered Variation Over Time")+
  scale_color_discrete(name = "Generation\nMethod") +
  theme(plot.title = element_text(hjust = 0.5),panel.background = element_rect(fill = 'white', color = 'white')) 
```


</center>

Due to the way the peaks and troughs of each source are either in phase or 180$^\circ$ out of phase, we clearly observe a close positive correlation between the two Hydro sources (correlation = 0.65), and a negative correlation between both these sources and Hard Coal (correlation with Hydro Reservoir = -0.16, with Hydro River = -0.5). The reason behind these relationships is likely to be that a more reliable energy source such as a coal is used to generate electricity when renewable (and therefore more desired) sources such as hydro power have lower output than is needed.  

The only obvious seasonality we detected was for Solar generation. In fact, Solar displayed seasonality on two different scales. In the following plot below we can see that this variable is seasonal on a daily scale, peaking between 11am and 2pm and hitting a low at 8am and the few hours prior. This is an intuitive periodicity: a location receives the most sunlight around noon, and no sunlight during the night.

<center>

![**Sample of Solar time series with hourly smoothing**](../figures/solar_hourly.png){width=80%}

</center>

In the next plot we can see that Solar is seasonal on a monthly scale. Electricity generation by solar peaks at around 2000MW in June or July each year, and hits a low of between 800MW and 1000MW in November or December each year. Once again, this periodicity makes intuitive sense, with higher generation in the summer months and lower generation in the winter months.

<center>

![**Solar time series with monthly smoothing**](../figures/solar_monthly.png){width=80%}

</center>

Although an early pioneer in renewable energy, changes in government policy including the reduction of financial incentives stymied the growth of renewable energy capacity in the country. This is especially true for solar power plants which have remained at a similar generation capacity between 2011 and 2017 (https://www.sciencedirect.com/science/article/pii/S0301421519304598#sec5).

```{r solar daily total}
data %>%
  mutate(Year=year(time), Month=month(time), Day=day(time)) %>%
  select(c(Year, Month, Day, Solar)) %>%
  mutate(Date=as.Date(with(., paste(Year, Month, Day,sep="-")), "%Y-%m-%d")) %>%
  group_by(Date) %>%
  summarise(Solar=sum(Solar)) %>%
  ggplot(aes(x=Date, y=Solar))+
  geom_line()+
  labs(x="Date", y="Power Generated (MW)", title="Total Photovoltaic Power Generation per Day")+
  scale_colour_viridis_d() +
  theme(plot.title = element_text(hjust = 0.5),panel.background = element_rect(fill = 'white', color = 'white')) 
```

From the above plot we can see that total daily power generated from photovoltaic solar systems shows little change across the years we investigated.


# Individual contributions

*1 page, 2 marks*

*Quick bullet points before writing up*

Daniel P:

Rob:

Daniel W:

- Investigated and wrote about outliers and effect of linear interpolation
- Investigated and wrote about correlations, long-term trends and seasonality 

# Conclusion
